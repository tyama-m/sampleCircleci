version: 2.1

jobs:
  build-mac-dev:
    macos:
      xcode: 13.4.0
#      resource_class: macos.x86.medium.gen2

    working_directory: $HOME/go/src/github.com/morisawa-tokyo-dev/morisawa-desktop-manager

    steps:
      - run: sudo systemsetup -settimezone Asia/Tokyo
      - checkout

#---------------------------------------------------
# fastlane update.
#---------------------------------------------------
      - run:
          name: "fastlane update"
          command: |
            cd $HOME/go/src/github.com/morisawa-tokyo-dev/morisawa-desktop-manager
            bundle update --bundler
            bundle install
            bundle update fastlane

#---------------------------------------------------
# 証明書の登録
#---------------------------------------------------
      - run:
          name: "fastlane match"
          command: |
            fastlane run opt_out_usage
            fastlane match development --readonly --skip_certificate_matching true

      # # fastlane import.
      # - run:
      #     name: "fastlane run opt_out_usage"
      #     command: |
      #       cd $HOME/go/src/github.com/morisawa-tokyo-dev/morisawa-desktop-manager
      #       bundle exec fastlane run opt_out_usage

      # - run:
      #     name: "fastlane match import"
      #     command: |
      #       cd $HOME/go/src/github.com/morisawa-tokyo-dev/morisawa-desktop-manager
      #       bundle exec fastlane match import --skip_certificate_matching true

#---------------------------------------------------
# ビルド
#---------------------------------------------------
      - run:
          name: "Build"
          command: |
            cd $HOME/go/src/github.com/morisawa-tokyo-dev/morisawa-desktop-manager
            sudo bash ./build.sh

workflows:
  version: 2.1
  fastlane-test_workflow:
    jobs:
      - build-mac-dev
